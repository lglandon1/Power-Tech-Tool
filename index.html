<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script>
    // Set theme on initial load to prevent flash of unstyled content
    (function () {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const savedTheme = localStorage.getItem('theme');
      const theme = savedTheme || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <title>Power Tech Tool - Mechanic Edition</title>
  
  <style>
    :root {
      --primary-color: #0d47a1; /* Professional Dark Blue */
      --primary-light: #1976d2;
      --secondary-color: #00695c; /* Professional Teal */
      --accent-color: #d32f2f; /* Red for errors/danger */
      --warning-color: #ef6c00; /* Orange for warnings */
      --background: #f4f5f7;
      --surface: #ffffff;
      --surface-alt: #eef2f6;
      --text-primary: #1a202c;
      --text-secondary: #4a5568;
      --border-color: #d2d6dc;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
      --border-radius: 12px;
      --border-radius-sm: 8px;
    }

    [data-theme="dark"] {
      --primary-color: #1565c0;
      --primary-light: #42a5f5;
      --secondary-color: #26a69a;
      --background: #1a202c;
      --surface: #2d3748;
      --surface-alt: #4a5568;
      --text-primary: #f7fafc;
      --text-secondary: #a0aec0;
      --border-color: #4a5568;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--background); color: var(--text-primary); line-height: 1.6; min-height: 100vh; font-size: 16px; }
    .container { max-width: 600px; margin: 0 auto; padding: 0.5rem; }

    .header { background: var(--surface); color: var(--text-primary); padding: 1rem; text-align: center; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; }
    .header-content { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
    .header h1 { font-size: 1.5rem; font-weight: 700; }
    .header .subtitle { font-size: 0.9rem; opacity: 0.9; color: var(--text-secondary); }
    .header-top-controls { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 0 0.5rem; margin-bottom: 1rem; }
    
    .unit-toggle-container { display: flex; align-items: center; gap: 0.5rem; background: var(--surface-alt); padding: 0.25rem 0.5rem; border-radius: 20px; }
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    input:checked + .slider { background-color: var(--secondary-color); }
    input:checked + .slider:before { transform: translateX(20px); }
    .unit-toggle-label { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); }

    .theme-toggle { background: var(--surface-alt); border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-secondary); transition: all 0.2s ease; }
    .theme-toggle:hover { background: var(--border-color); }
    .theme-toggle svg { width: 20px; height: 20px; }

    .card { background: var(--surface); border-radius: var(--border-radius); box-shadow: var(--shadow); border: 1px solid var(--border-color); overflow: hidden; transition: box-shadow 0.2s ease; margin-bottom: 1.5rem; }
    .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); }
    .card-header h2 { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.75rem; }
    .card-content { padding: 1.5rem; }

    .grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    .menu-button { background: var(--surface); border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); padding: 1rem; text-align: left; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 1rem; }
    .menu-button:hover { border-color: var(--primary-color); background: var(--surface-alt); transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .menu-button .icon { width: 40px; height: 40px; background: var(--primary-light); color: white; border-radius: var(--border-radius-sm); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .menu-button h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem; color: var(--text-primary); }
    .menu-button p { font-size: 0.875rem; color: var(--text-secondary); line-height: 1.4; }
    
    .radio-group label { display: flex; align-items: center; gap: 0.5rem; }

    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-primary); font-size: 0.9rem; }
    .form-input, .form-select { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); background: var(--surface); color: var(--text-primary); font-size: 1rem; transition: all 0.2s ease; }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.1); }
    
    .button-group { display: flex; gap: 1rem; margin-top: 2rem; flex-direction: column; }
    .btn { padding: 0.85rem 1.5rem; border: none; border-radius: var(--border-radius-sm); font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-size: 1rem; }
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-primary:hover { background-color: var(--primary-light); }
    .btn-secondary { background: var(--surface-alt); color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background: var(--border-color); }

    .result-panel { background: var(--surface-alt); border-radius: var(--border-radius); padding: 1.5rem; margin-top: 2rem; border: 1px solid var(--border-color); }
    .result-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); gap: 1rem; }
    .result-item:last-child { border-bottom: none; }
    .result-label { font-weight: 500; color: var(--text-primary); white-space: nowrap; }
    .result-value { font-weight: 500; color: var(--text-secondary); text-align: right; }
    .result-value .primary { color: var(--text-primary); font-weight: 600; display: block; }
    .result-value .secondary { font-size: 0.9em; }

    .hidden { display: none !important; }
    
    .btn-copy { background: var(--secondary-color); color: white; font-size: 0.8rem; padding: 0.5rem 1rem; margin-top: 1.5rem; border-radius: var(--border-radius-sm); text-align: center; width: 100%; }

    .splash-screen { text-align: center; padding: 3rem 1rem; }
    .splash-screen img { width: 100px; height: 100px; margin-bottom: 1rem; }
    .splash-screen h1 { font-size: 2rem; }
    .splash-screen p { color: var(--text-secondary); margin-bottom: 2rem; }

    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .slide-in { animation: slideIn 0.4s ease-out forwards; }
    
    /* DESKTOP STYLES */
    @media (min-width: 640px) {
      .container { padding: 1rem; }
      .grid { grid-template-columns: 1fr 1fr; }
      .button-group { flex-direction: row; }
      .header h1 { font-size: 2rem; }
      .btn-copy { width: auto; max-width: 200px; margin-left: auto; margin-right: 0; }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div id="splash-screen" class="splash-screen slide-in">
        <img src="https://github.com/lglandon1/Power-Tech-Tool/raw/main/Light%20Icon%20No%20Background.png" 
             alt="Power Tech Tool Icon" onerror="this.onerror=null; this.remove();">
        <h1>Power Tech Tool</h1>
        <p>Your Electrical & Mechanical Conversion Assistant</p>
        <button id="start-btn" class="btn btn-primary">Start Calculating</button>
    </div>

    <div id="app-container" class="hidden">
        <header class="header">
            <div class="header-top-controls">
                <div class="unit-toggle-container">
                    <span class="unit-toggle-label">METRIC</span>
                    <label class="switch">
                        <input type="checkbox" id="unit-toggle" checked>
                        <span class="slider"></span>
                    </label>
                    <span class="unit-toggle-label">IMPERIAL</span>
                </div>
                <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
                    <svg class="sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg class="moon-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display:none;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
          <div id="header-content" class="header-content">
            <h1>Power Tech Tool</h1>
            <p class="subtitle">Select a Calculation</p>
          </div>
        </header>

        <div id="main-menu">
          <div class="grid">
             <!-- NEW Buttons -->
            <div class="menu-button" data-calc="gen-sizing"><div class="icon"><svg fill="currentColor" viewBox="0 0 20 20"><path d="M11 17a1 1 0 001.447.894l4-2A1 1 0 0017 15V5a1 1 0 00-1.447-.894l-4 2A1 1 0 0011 7v10zM5 17a1 1 0 001.447.894l4-2A1 1 0 0011 15V5a1 1 0 00-1.447-.894l-4 2A1 1 0 005 7v10z"></path></svg></div><div><h3>Generator Sizing</h3><p>Recommend a generator size</p></div></div>
            <div class="menu-button" data-calc="fuel-runtime"><div class="icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd"></path></svg></div><div><h3>Fuel Runtime</h3><p>Estimate remaining run time</p></div></div>
            <div class="menu-button" data-calc="fuel-level"><div class="icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 4a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3H5zm-1 9v-1h5v2H5a1 1 0 01-1-1zm7 1h4a1 1 0 001-1V7a1 1 0 00-1-1h-4v8z" clip-rule="evenodd"></path></svg></div><div><h3>Fuel Level Converter</h3><p>Convert %, L, or Gal</p></div></div>
            <div class="menu-button" data-calc="rpm-freq"><div class="icon"><svg fill="currentColor" viewBox="0 0 20 20"><path d="M10 4.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM10 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM10 12.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3z"></path></svg></div><div><h3>RPM ⇔ Frequency</h3><p>Check engine speed and Hz</p></div></div>
            <!-- Existing buttons with new icons -->
            <div class="menu-button" data-calc="single-phase"><div class="icon"><svg fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg></div><div><h3>Single Phase Power</h3><p>Calculate power for 1Ø circuits</p></div></div>
            <div class="menu-button" data-calc="three-phase"><div class="icon"><svg fill="currentColor" viewBox="0 0 20 20"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1z"></path></svg></div><div><h3>Three Phase Power</h3><p>Calculate power for 3Ø systems</p></div></div>
            <div class="menu-button" data-calc="voltage-drop"><div class="icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg></div><div><h3>Voltage Drop</h3><p>Calculate voltage drop in cables</p></div></div>
          </div>
        </div>

        <div id="calculation-forms">
            <!-- Forms will be injected here by JS -->
        </div>
    </div>
  </div>

<script>
    // --- GLOBAL SETTINGS & STATE ---
    let displayUnit = 'imperial'; 
    let currentForm = null;

    const CONVERSIONS = {
        L_TO_GAL: 0.264172,
        M_TO_FT: 3.28084,
        KW_TO_HP: 1.34102,
        AWG_TO_MM2: { '14': 2.08, '12': 3.31, '10': 5.26, '8': 8.37, '6': 13.3, '4': 21.15, '2': 33.6, '1/0': 53.5, '2/0': 67.4, '4/0': 107.2 }
    };

    // --- FORM DEFINITIONS ---
    const forms = [
        { id: 'gen-sizing', title: 'Generator Sizing', content: `<div class="form-group"><label for="gs-running-load">Total Running Load (kW):</label><input type="number" id="gs-running-load" class="form-input"></div><div class="form-group"><label for="gs-starting-load">Largest Starting Load (kVA):</label><input type="number" id="gs-starting-load" class="form-input"></div><div class="form-group"><label for="gs-pf">Average Power Factor:</label><input type="number" id="gs-pf" class="form-input" value="0.8" step="0.01"></div><div class="form-group"><label for="gs-overhead">Safety Overhead (%):</label><input type="number" id="gs-overhead" class="form-input" value="25"></div>` },
        { id: 'fuel-runtime', title: 'Fuel Runtime', content: `<div class="form-group"><label>Tank Capacity Unit:</label><div class="radio-group"><label><input type="radio" name="fr-unit" value="gal" checked> Gallons</label><label><input type="radio" name="fr-unit" value="lit"> Liters</label></div></div><div class="form-group"><label for="fr-capacity">Tank Capacity:</label><input type="number" id="fr-capacity" class="form-input"></div><div class="form-group"><label for="fr-load">Current Generator Load (kW):</label><input type="number" id="fr-load" class="form-input"></div>` },
        { id: 'fuel-level', title: 'Fuel Level Converter', content: `<div class="form-group"><label>Total Tank Capacity:</label><input id="fl-capacity" type="number" class="form-input"><div class="radio-group" style="margin-top:0.5rem;"><label><input type="radio" name="fl-cap-unit" value="gal" checked> Gallons</label><label><input type="radio" name="fl-cap-unit" value="lit"> Liters</label></div></div><hr style="border:none;border-top:1px solid var(--border-color);margin:1.5rem 0;"><div class="form-group"><label>Current Fuel Level:</label><input id="fl-current" type="number" class="form-input"><div class="radio-group" style="margin-top:0.5rem;"><label><input type="radio" name="fl-curr-unit" value="percent" checked> Percent (%)</label><label><input type="radio" name="fl-curr-unit" value="gal"> Gallons</label><label><input type="radio" name="fl-curr-unit" value="lit"> Liters</label></div></div>`},
        { id: 'rpm-freq', title: 'RPM ⇔ Frequency', content: `<p style="font-size:0.9em;color:var(--text-secondary);margin-bottom:1.5rem;">Enter two values to calculate the third.</p><div class="form-group"><label for="rf-rpm">Engine Speed (RPM):</label><input type="number" id="rf-rpm" class="form-input"></div><div class="form-group"><label for="rf-freq">Frequency (Hz):</label><input type="number" id="rf-freq" class="form-input"></div><div class="form-group"><label for="rf-poles">Alternator Poles:</label><input type="number" id="rf-poles" class="form-input"></div>` },
        { id: 'single-phase', title: 'Single Phase Power', content: `<div class="form-group"><label for="sp-voltage">Voltage (V):</label><input type="number" id="sp-voltage" class="form-input" value="416"></div><div class="form-group"><label for="sp-current">Current (A):</label><input type="number" id="sp-current" class="form-input"></div><div class="form-group"><label for="sp-pf">Power Factor:</label><input type="number" id="sp-pf" class="form-input" value="0.85" step="0.01"></div>` },
        { id: 'three-phase', title: 'Three Phase Power', content: `<div class="form-group"><label for="tp-voltage">Line-to-Line Voltage (V):</label><input type="number" id="tp-voltage" class="form-input" value="416"></div><div class="form-group"><label for="tp-current1">L1 Current (A):</label><input type="number" id="tp-current1" class="form-input"></div><div class="form-group"><label for="tp-current2">L2 Current (A):</label><input type="number" id="tp-current2" class="form-input"></div><div class="form-group"><label for="tp-current3">L3 Current (A):</label><input type="number" id="tp-current3" class="form-input"></div><div class="form-group"><label for="tp-pf">Power Factor:</label><input type="number" id="tp-pf" class="form-input" value="0.85" step="0.01"></div>` },
        { id: 'voltage-drop', title: 'Voltage Drop', content: `<div class="form-group"><label for="vd-voltage">System Voltage (V):</label><input type="number" id="vd-voltage" class="form-input" value="416"></div><div class="form-group"><label>Conductor Size Unit:</label><div class="radio-group"><label><input type="radio" name="vd-size-unit" value="awg" checked> AWG</label><label><input type="radio" name="vd-size-unit" value="mm2"> mm²</label></div></div><div class="form-group" id="vd-awg-group"><label for="vd-size-awg">Conductor Size (AWG):</label><select id="vd-size-awg" class="form-select">${Object.keys(CONVERSIONS.AWG_TO_MM2).map(awg => `<option value="${awg}">${awg}</option>`).join('')}</select></div><div class="form-group hidden" id="vd-mm2-group"><label for="vd-size-mm2">Conductor Size (mm²):</label><input type="number" id="vd-size-mm2" class="form-input"></div><div class="form-group"><label for="vd-current">Load Current (A):</label><input type="number" id="vd-current" class="form-input"></div><div class="form-group"><label>Length Unit:</label><div class="radio-group"><label><input type="radio" name="vd-len-unit" value="ft" checked> Feet</label><label><input type="radio" name="vd-len-unit" value="m"> Meters</label></div></div><div class="form-group"><label for="vd-length">One-Way Cable Length:</label><input type="number" id="vd-length" class="form-input"></div>`},
    ];

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
      initTheme();
      buildAllForms();
      setupEventListeners();
    });

    function setupEventListeners() {
      document.getElementById('start-btn').addEventListener('click', () => {
        document.getElementById('splash-screen').classList.add('hidden');
        const app = document.getElementById('app-container');
        app.classList.remove('hidden');
        app.classList.add('slide-in');
      });

      const unitToggle = document.getElementById('unit-toggle');
      displayUnit = unitToggle.checked ? 'imperial' : 'metric';
      unitToggle.addEventListener('change', () => { displayUnit = unitToggle.checked ? 'imperial' : 'metric'; });
      
      document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
      
      document.querySelectorAll('.menu-button').forEach(button => {
        button.addEventListener('click', () => showForm(button.dataset.calc));
      });
    }

    function initTheme() {
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', savedTheme);
        const sunIcon = document.querySelector('.sun-icon');
        const moonIcon = document.querySelector('.moon-icon');
        if (savedTheme === 'dark') { moonIcon.style.display = 'block'; sunIcon.style.display = 'none'; } 
        else { sunIcon.style.display = 'block'; moonIcon.style.display = 'none'; }
    }
    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const newTheme = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        initTheme();
    }

    // --- UI & NAVIGATION ---
    function showMainMenu() {
        document.getElementById('main-menu').classList.remove('hidden');
        const formsContainer = document.getElementById('calculation-forms');
        formsContainer.classList.add('hidden');
        if (currentForm) {
            document.getElementById(`${currentForm}-form`).classList.add('hidden');
            currentForm = null;
        }
        document.getElementById('header-content').querySelector('p').textContent = "Select a Calculation";
        window.scrollTo(0, 0);
    }

    function showForm(formId) {
        if (currentForm) { document.getElementById(`${currentForm}-form`).classList.add('hidden'); }
        document.getElementById('main-menu').classList.add('hidden');
        const formsContainer = document.getElementById('calculation-forms');
        formsContainer.classList.remove('hidden');
        const formCard = document.getElementById(`${formId}-form`);
        formCard.classList.remove('hidden');
        formCard.classList.add('slide-in');
        document.getElementById('header-content').querySelector('p').textContent = forms.find(f => f.id === formId).title;
        currentForm = formId;
        window.scrollTo(0, 0);
    }
    
    // --- FORM & RESULT RENDERING ---
    function buildAllForms() {
        const container = document.getElementById('calculation-forms');
        forms.forEach(form => {
            const card = document.createElement('div');
            card.id = `${form.id}-form`;
            card.className = 'card hidden';
            card.innerHTML = `
                <div class="card-header"><h2>${form.title}</h2></div>
                <div class="card-content">
                    ${form.content}
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showMainMenu()">← Back</button>
                        <button class="btn btn-primary" onclick="calculate('${form.id}')">Calculate</button>
                    </div>
                    <div id="${form.id}-result" class="result-panel hidden"></div>
                </div>
            `;
            container.appendChild(card);
        });
        
        // Post-build event listeners for dynamic elements
        const vdSizeUnitInputs = document.querySelectorAll('input[name="vd-size-unit"]');
        if (vdSizeUnitInputs) {
            vdSizeUnitInputs.forEach(input => {
                input.addEventListener('change', (e) => {
                    document.getElementById('vd-awg-group').classList.toggle('hidden', e.target.value !== 'awg');
                    document.getElementById('vd-mm2-group').classList.toggle('hidden', e.target.value !== 'mm2');
                });
            });
        }
    }

    function showResult(formId, data) {
      const container = document.getElementById(`${formId}-result`);
      container.classList.remove('hidden');
      
      let textToCopy = `--- ${forms.find(f => f.id === formId).title.toUpperCase()} ---\n`;
      let resultHTML = '';

      data.forEach(item => {
        let valueHTML = '';
        if (typeof item.value === 'object' && item.value !== null) {
          const primary = displayUnit === 'imperial' ? item.value.imperial : item.value.metric;
          const secondary = displayUnit === 'imperial' ? item.value.metric : item.value.imperial;
          valueHTML = `<span class="primary">${primary}</span> <span class="secondary">(${secondary})</span>`;
          textToCopy += `${item.label}: ${primary} (${secondary})\n`;
        } else {
          valueHTML = `<span class="primary">${item.value}</span>`;
          textToCopy += `${item.label}: ${item.value}\n`;
        }
        resultHTML += `<div class="result-item"><span class="result-label">${item.label}</span><span class="result-value">${valueHTML}</span></div>`;
      });
      
      resultHTML += `<button class="btn btn-copy" onclick="copyToClipboard(this)">Copy Results</button>`;
      container.innerHTML = resultHTML;
      container.dataset.copytext = textToCopy.trim();
    }
    
    function copyToClipboard(button) {
        const textToCopy = button.parentElement.dataset.copytext;
        navigator.clipboard.writeText(textToCopy).then(() => {
            button.textContent = 'Copied!';
            setTimeout(() => { button.textContent = 'Copy Results' }, 2000);
        });
    }

    // --- MASTER CALCULATION ROUTER ---
    function calculate(formId) {
        try {
            let results = [];
            switch(formId) {
                case 'gen-sizing':
                    const runningKW = parseFloat(document.getElementById('gs-running-load').value);
                    const startingKVA = parseFloat(document.getElementById('gs-starting-load').value);
                    const pf = parseFloat(document.getElementById('gs-pf').value);
                    const overhead = parseFloat(document.getElementById('gs-overhead').value);
                    const runningKVA = runningKW / pf;
                    const totalKVA = runningKVA + startingKVA;
                    const finalKVA = totalKVA * (1 + overhead / 100);
                    const finalKW = finalKVA * pf;
                    results = [
                        { label: 'Running Load', value: { metric: `${runningKW.toFixed(1)} kW`, imperial: `${(runningKW * CONVERSIONS.KW_TO_HP).toFixed(1)} HP` } },
                        { label: 'Recommended Size', value: { metric: `${finalKVA.toFixed(1)} kVA`, imperial: `${finalKW.toFixed(1)} kW` } }
                    ];
                    break;
                case 'fuel-runtime':
                    const capacity = parseFloat(document.getElementById('fr-capacity').value);
                    const unit = document.querySelector('input[name="fr-unit"]:checked').value;
                    const loadKW = parseFloat(document.getElementById('fr-load').value);
                    const consumptionLPH = (loadKW * 0.21) / 0.85; 
                    const capacityL = unit === 'lit' ? capacity : capacity / CONVERSIONS.L_TO_GAL;
                    const runtimeHours = capacityL / consumptionLPH;
                    const days = Math.floor(runtimeHours / 24);
                    const hours = Math.floor(runtimeHours % 24);
                    results = [
                        { label: 'Est. Runtime', value: `${days}d ${hours}h` },
                        { label: 'Consumption Rate', value: { metric: `${consumptionLPH.toFixed(2)} L/h`, imperial: `${(consumptionLPH * CONVERSIONS.L_TO_GAL).toFixed(2)} gal/h` } }
                    ];
                    break;
                case 'fuel-level':
                    const capValue = parseFloat(document.getElementById('fl-capacity').value);
                    const capUnit = document.querySelector('input[name="fl-cap-unit"]:checked').value;
                    const currValue = parseFloat(document.getElementById('fl-current').value);
                    const currUnit = document.querySelector('input[name="fl-curr-unit"]:checked').value;

                    if(isNaN(capValue) || isNaN(currValue)) {
                        throw new Error("Please enter numeric values for capacity and current level.");
                    }

                    const tankLiters = capUnit === 'lit' ? capValue : capValue / CONVERSIONS.L_TO_GAL;
                    const tankGallons = tankLiters * CONVERSIONS.L_TO_GAL;
                    let currentLiters = 0;

                    if (currUnit === 'percent') {
                        currentLiters = tankLiters * (currValue / 100);
                    } else if (currUnit === 'gal') {
                        currentLiters = currValue / CONVERSIONS.L_TO_GAL;
                    } else { // lit
                        currentLiters = currValue;
                    }
                    
                    if (currentLiters > tankLiters * 1.001) { // Add a small tolerance for floating point issues
                        throw new Error("Current level cannot be greater than tank capacity.");
                    }

                    const currentGallons = currentLiters * CONVERSIONS.L_TO_GAL;
                    const currentPercent = (tankLiters > 0) ? (currentLiters / tankLiters) * 100 : 0;
                    
                    results = [
                        { label: 'Total Capacity', value: { metric: `${tankLiters.toFixed(1)} L`, imperial: `${tankGallons.toFixed(1)} gal` }},
                        { label: 'Current Level', value: { metric: `${currentLiters.toFixed(1)} L`, imperial: `${currentGallons.toFixed(1)} gal` }},
                        { label: 'Tank Percentage', value: `${currentPercent.toFixed(1)} %` }
                    ];
                    break;
                case 'rpm-freq':
                    const rpm = document.getElementById('rf-rpm').value;
                    const freq = document.getElementById('rf-freq').value;
                    const poles = document.getElementById('rf-poles').value;
                    let resultLabel, resultValue;
                    if(rpm && freq) { resultValue = (freq * 120) / rpm; resultLabel = 'Calculated Poles'; }
                    else if (rpm && poles) { resultValue = (rpm * poles) / 120; resultLabel = 'Calculated Hz'; }
                    else if (freq && poles) { resultValue = (freq * 120) / poles; resultLabel = 'Calculated RPM'; }
                    results = [{ label: resultLabel, value: resultValue.toFixed(1) }];
                    break;
                case 'single-phase':
                    const spV = parseFloat(document.getElementById('sp-voltage').value);
                    const spI = parseFloat(document.getElementById('sp-current').value);
                    const spPF = parseFloat(document.getElementById('sp-pf').value);
                    const spKW = (spV * spI * spPF) / 1000;
                    results = [
                        { label: 'Real Power', value: { metric: `${spKW.toFixed(2)} kW`, imperial: `${(spKW * CONVERSIONS.KW_TO_HP).toFixed(2)} HP` } },
                        { label: 'Apparent Power', value: `${(spV * spI / 1000).toFixed(2)} kVA` }
                    ];
                    break;
                case 'three-phase':
                    const tpV = parseFloat(document.getElementById('tp-voltage').value);
                    const tpI1 = parseFloat(document.getElementById('tp-current1').value);
                    const tpI2 = parseFloat(document.getElementById('tp-current2').value);
                    const tpI3 = parseFloat(document.getElementById('tp-current3').value);
                    const tpPF = parseFloat(document.getElementById('tp-pf').value);
                    const avgI = (tpI1 + tpI2 + tpI3) / 3;
                    const tpKW = (tpV * avgI * tpPF * Math.sqrt(3)) / 1000;
                    results = [
                        { label: 'Real Power', value: { metric: `${tpKW.toFixed(2)} kW`, imperial: `${(tpKW * CONVERSIONS.KW_TO_HP).toFixed(2)} HP` } },
                        { label: 'Average Current', value: `${avgI.toFixed(1)} A` }
                    ];
                    break;
                case 'voltage-drop':
                    const vdV = parseFloat(document.getElementById('vd-voltage').value);
                    const vdI = parseFloat(document.getElementById('vd-current').value);
                    const vdLen = parseFloat(document.getElementById('vd-length').value);
                    const lenUnit = document.querySelector('input[name="vd-len-unit"]:checked').value;
                    const sizeUnit = document.querySelector('input[name="vd-size-unit"]:checked').value;
                    let mm2;
                    if(sizeUnit === 'awg'){
                        mm2 = CONVERSIONS.AWG_TO_MM2[document.getElementById('vd-size-awg').value];
                    } else {
                        mm2 = parseFloat(document.getElementById('vd-size-mm2').value);
                    }
                    const lenFt = lenUnit === 'ft' ? vdLen : vdLen * CONVERSIONS.M_TO_FT;
                    const cmil = mm2 * 1973.5;
                    const vdVolts = (2 * 12.9 * vdI * lenFt) / cmil;
                    const vdPercent = (vdVolts / vdV) * 100;
                     results = [
                        { label: 'Voltage Drop', value: { metric: `${vdVolts.toFixed(1)} V`, imperial: `${vdPercent.toFixed(2)} %` } },
                        { label: 'Voltage at Load', value: `${(vdV - vdVolts).toFixed(1)} V` }
                    ];
                    break;
            }
            showResult(formId, results);
        } catch(e) {
            alert("Please check your inputs. " + (e.message || "An error occurred."));
        }
    }
</script>
</body>
</html>
